
@{
    ViewBag.Title = "Add Transaction";
}

<!-- NEEDED FOR SPINNER DIALOG -->

<script src="~/Scripts/Utilities.js"></script>

<script>
    $(function () {
        var CustomerID;

        $('[data-toggle="tooltip"]').tooltip();
        $.fn.bootstrapBtn = $.fn.button.noConflict();

        $("#lnkAdd").on('click', function (event) {
            newtransactiondialog.dialog("open");
        });

        $("#btnSubmit").on('click', function (event) {
            if ($('#tblTrans tr').length < 3) {
                alert('There are no transactions details.');
            } else {
                transaction = {
                    BusinessID: 0,
                    CustomerID: @Url.RequestContext.RouteData.Values["id"],
                    AssociateID: 0,
                    TotalAmount: $('#tblTrans').find('tr:last td:nth-child(5)').text().replace('$', '').replace(',', '').replace('.00', ''),
                    TransactionDate: (new Date()).toUTCString(), //PT - add time in the client side
                    ModifiedDate: (new Date()).toUTCString() //PT - add time in the client side
                };

                var transactiondetails = new Array();


                $('#tblTrans tr:not(:first-child)').each(function () {

                    if (!$(this).is(":last-child")) {

                        transdet = {
                            FormID: $(this).attr('id'),
                            FormTitle: $(this).find('td:nth-child(1)').text(),
                            UnitPrice: $(this).find('td:nth-child(3)').text().replace('$', '').replace(',', '').replace('.00', ''),
                            DiscountPrice: $(this).find('td:nth-child(4)').text().replace('$','').replace(',','').replace('.00',''),
                            Quantity: $(this).find('td:nth-child(2)').text(),
                            Notes: $(this).find('td:nth-child(6)').text(),
                            Total: $(this).find('td:nth-child(5)').text().replace('$', '').replace(',', '').replace('.00', '')
                        }

                        transactiondetails.push(transdet);
                    }
                });

                $.ajax({
                    url: '/transactions/AddNewTransaction/',
                    type: 'POST',
                    data: JSON.stringify({ transaction: transaction, transactiondetails: transactiondetails }),
                    dataType: 'json',
                    traditional: true,
                    contentType: 'application/json;',
                    success: function (result) {
                        if (result != '0') {
                            document.location.href='/transactions/transactiondetails/' + result;
                            //window.location();
                            //return false;
                        } else {
                            //alert("Error: Customer transaction update has failed.");
                            $.AlertDialog('Error: Customer transaction update has failed.', 'Error Message', function (event) { }, 'lightcoral');
                        }
                    }
                });
            }
        });

        var newtransactiondialog = $("#new-transaction-dialog").dialog({
            autoOpen: false,
            draggable: false,
            height: 500,
            width: $(window).width() * .6,
            stack: true,
            modal: true,
            buttons: {
                "Update": AddTransactionDetail,
                Cancel: function () {
                    newtransactiondialog.dialog("close");
                }
            },
            close: function () {
                newtransactiondialog.dialog("close");
            }
        });


        var listdialog = $("#list-dialog").dialog({
            autoOpen: false,
            draggable: false,
            height: 500,
            width: $(window).width() * .6,
            stack: true,
            modal: true,
            open: function() {
                $.ajax({
                    url: '/transactions/GetForms/',
                    dataType: "json",
                    success: function (data) {


                        $('#lstForms').empty();
                        var option='';

                        $.each(data, function (index, item) {
                            option = '<option value="' + item.FormID + '" data-price=' + item.Price + '>' + item.Title + '</option>';
                            $('#lstForms').append(option);
                        });


                    }, error: function(xhr){
                        //alert('Request Status: ' + xhr.status + ' Status Text: ' + xhr.statusText + ' ' + xhr.responseText);
                        $.AlertDialog('Request Status: ' + xhr.status + ' Status Text: ' + xhr.statusText + ' ' + xhr.responseText, 'Error Message', function (event) { }, 'lightcoral');
                    }
                });

            },
            buttons: {
                "OK": function(){
                    $('#hdnFormID').val($('#lstForms').find(":selected").val());
                    $('#forms').val(  $('#lstForms').find(":selected").text() );

                    $('#txtPrice').val($('#lstForms').find(":selected").data('price'));
                    $('#txtQuantity').val('1');


                    updateSubtotal();
                    listdialog.dialog("close");
                },
                Cancel: function () {
                    listdialog.dialog("close");
                }
            },
            close: function () {
                listdialog.dialog("close");
            }
        });



        function AddTransactionDetail() {
            var elements = document.querySelectorAll('[data-required="true"]');
            var alertTriggered = false;

            $.each(elements, function (index, item) {
                if (item.value == '') {
                    item.style.borderColor = 'red';

                    if (!alertTriggered) {
                        //alert(item.dataset.name + " is required.");
                        $.AlertDialog(item.dataset.name + ' is required.', 'Error Message', function (event) { }, 'lightcoral');
                        item.focus();
                    }

                    alertTriggered = true;
                }
                else {
                    item.style.borderColor = '#cccccc';
                }
            });

            if (alertTriggered) {
                return;
            }

            if ($('#hdnFormID').val() == '') {
                //alert('No transaction item has been selected.');
                $.AlertDialog('No transaction item has been selected.', 'Error Message', function (event) { }, 'lightcoral');
                return;
            }

            if ($('#txtDiscount').val() != '' && $('#txtNote').val() == '') {
                //alert('You must include a note if you are discounting the price.');
                $.AlertDialog('You must include a note if you are discounting the price.', 'Error Message', function (event) { }, 'lightcoral');
                $('#txtDiscount').focus();
                return false;
            }

            $('#tblTrans tr:last').remove();

            var subtotal;

            if ($('#txtDiscount').val() == '') {
                subtotal = parseFloat($('#txtQuantity').val()) * parseFloat($('#txtPrice').val());
            }
            else {
                subtotal = parseFloat($('#txtQuantity').val()) * parseFloat($('#txtDiscount').val());
            }

            TransactionDetail = "<tr id=\"" + $('#hdnFormID').val() + "\">" +

                                    "<td>" + $('#forms').val() + "</td>" +
                                    "<td>" + $('#txtQuantity').val() + "</td>" +
                                    "<td class='currencyLabel'>" + $('#txtPrice').val() + "</td>" +
                                    "<td class='currencyLabel'>" + $('#txtDiscount').val() + "</td>" +
                                    "<td class='currencyLabel'>" + subtotal + "</td>" +
                                    "<td>" + $('#txtNote').val() + "</td>" +
                                    "<td> <a href='#' class='removeTrans'><img src='/images/delete.png' /></a> </td>" +
                                "</tr>";

            $("#tblTrans").append(TransactionDetail);

            $('#hdnFormID').val('');
            $('#forms').val('');
            $('#txtPrice').val('');
            $('#txtDiscount').val('');
            $('#txtQuantity').val('');
            $('#txtNote').val('');

            TotalUp();

            newtransactiondialog.dialog("close");
        }

        $(document).on('click', '.removeTrans', function () {
            $(this).closest('tr').remove();
            $('#tblTrans tr:last').remove();
            TotalUp();
        });

        $('#search').on('click', function () {
            listdialog.dialog("open");
        });

        function TotalUp() {
            var total = 0;

            $('#tblTrans tr:not(:first-child)').each(function () {

                total += parseFloat($(this).find('td:eq(4)').text().replace(',','').replace('$',''));

            });

            totalRow = "<tr id=\"" + $('#hdnFormID').val() + "\">" +

                                            "<td></td>" +
                                            "<td></td>" +
                                            "<td></td>" +
                                            "<td><strong>TOTAL:</strong></td>" +
                                            "<td class='currencyLabel'>" + total + "</td>" +
                                            "<td></td>" +
                                            "<td></td>" +
                                        "</tr>";

            $("#tblTrans").append(totalRow);

            $('.currencyLabel').formatCurrency();
        }

        $("#forms").autocomplete({
            source: function (request, response) {
                $.ajax({
                    beforeSend: function () { },
                    url: '/transactions/SearchForms/',
                    dataType: "json",
                    data: {
                        SearchCriteria: request.term
                    },
                    success: function (data) {
                        return response($.map(data, function (item) {
                            return {
                                label: item.Title,
                                value: item.FormID,
                                formprice: item.Price
                            };
                        }))
                    },
                    minLength: 2,
                });
            },
            select: function (event, ui) {

                $('#forms').val(ui.item.label);
                $('#txtPrice').val(ui.item.formprice);
                $('#hdnFormID').val(ui.item.value);
                $('#txtQuantity').val('1');
                updateSubtotal();
                return false;
            },
            //focus: function (event, ui) {
            //    event.preventDefault();
            //    $(this).val(ui.item.label);
            //},
            change: function (event, ui) {
                if (!ui.item) {
                    $('#txtPrice').val('');
                    $('#hdnFormID').val('');
                    $('#txtQuantity').val('');

                    updateSubtotal();
                    return false;
                }
            }
        });
    });

    function updateSubtotal() {
        if ($('#txtQuantity').val() == '' || $('#txtPrice').val() == '') {
            $('#txtSubtotal').val(0);
            return;
        }


        var subtotal;

        if ($('#txtDiscount').val() == '') {
            subtotal = parseFloat($('#txtQuantity').val()) * parseFloat($('#txtPrice').val());
        }
        else {
            subtotal = parseFloat($('#txtQuantity').val()) * parseFloat($('#txtDiscount').val());
        }

        $('#txtSubtotal').val(subtotal)
    }
</script>

@{
    var custid = ((AHDDManagerClass.Customer)Session["SelectedCustomer"]).CustomerID;
    var custname = ((AHDDManagerClass.Customer)Session["SelectedCustomer"]).FullName;
}

<h2>Add Transaction</h2>

<div class="well">
    <div class="row">
        <div class="col-lg-6"><strong>Customer:</strong> <div>@custname</div></div>
        <div class="col-lg-6"><strong>Customer ID:</strong> <div>@Url.RequestContext.RouteData.Values["id"]</div></div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <a href="#" id="lnkAdd">
            <img src="~/images/addtransactionitem.png" data-toggle="tooltip" data-placement="right" title="Add New Transaction Item" />
        </a>
    </div>
    <div class="col-lg-6">
        <a href="/transactions/customertransactions/@Url.RequestContext.RouteData.Values["id"]" class="pull-right">
            <img src="~/images/GoBack.png" data-toggle="tooltip" data-placement="left" title="Back to Transactions" />
        </a>
    </div>
</div>

<table id="tblTrans" class="table table-hover">
    <tr>
        <th>Transaction Item</th>
        <th>Quantity</th>
        <th>Unit Price</th>
        <th>Discount Price</th>
        <th>Sub-Total</th>
        <th>Note</th>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td>TOTAL:</td>
        <td>0</td>
        <td></td>
    </tr>
</table>
<div class="row">
    <div class="col-sm-12">
        <button id="btnSubmit" class="btn btn-success pull-right">Submit</button>
    </div>
</div>

<div id="new-transaction-dialog" title="Add New Transaction">
    <input type="hidden" id="hdnFormID" />

    <div class="container">


        <table id="tblTransDetails" class="table">
            <tr>
                <td colspan="2">

                    <label for="code">Transaction Item:</label><br />
                    <input type="text" id="forms" data-required="true" data-name="Transaction Item" class="form-control" style="max-width:700px;">




                </td>
                <td valign="bottom" class="text-left"><img src="~/images/search.png" id="search" style="padding-top:20px;" /></td>
            </tr>
            <tr>
                <td>
                    <label for="txtQuantity">Quantity</label><input type="text" id="txtQuantity" class="form-control" data-required="true" onkeypress='numericValidate(event);' onkeyup="updateSubtotal();" data-name="Quantity" onchange="updateSubtotal()" />
                </td>
                <td>
                    <label for="txtPrice">Unit Price</label> <input type="text" id="txtPrice" class="form-control" onkeypress='numericValidate(event)' onkeyup="updateSubtotal();" maxlength="5" data-required="true" data-name="Unit Price" onchange="updateSubtotal()" />
                </td>
                <td>
                    <label for="txtDiscount">Discount Price</label><input type="text" class="form-control" onkeypress='numericValidate(event)' onkeyup="updateSubtotal();" id="txtDiscount" onchange="updateSubtotal()" />
                </td>
                <td>
                    <label for="txtSubtotal">Sub-total</label><input type="text" class="form-control" id="txtSubtotal" value="0" readonly/>
                </td>
            </tr>

            <tr>
                <td colspan="4">
                    <div class="form-group">
                        <label for="comment">Note:</label>
                        <textarea class="form-control" rows="6" style="min-width: 100%" id="txtNote"></textarea>
                    </div>
                </td>

            </tr>
        </table>
    </div>
</div>

<div id="list-dialog" title="Forms">
    <select id="lstForms" size="18" class="form-control"></select>
</div>